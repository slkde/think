<?php
namespace pay\xlpay;

class Xlpay{

   
   protected  $array  = [

        'service' => 'create_instant_order',
        'version' => '1.2',
        'request_time' => '',
        'partner_id' => '200075255426',
        '_input_charset' => 'utf-8',
        'sign_type' => 'RSA',
        'sign_version' => '1.0',
        'notify_url' => '',
        'return_url' => '',
        'memo' => '',
        'out_trade_no' => '',
        'seller_identity_id' => '200075255426',
        'seller_identity_type' => 'MEMBER_ID',
        'amount' => '',
        'expired_time' => '3m',
        'goods_id' => '1',
        'goods_name' => '充值',
        'goods_num' => '1',
        'goods_price' => '',

    ];

   public function  pay($array)
   {
		$this->array['return_url'] = $array['return_url'];
		$this->array['notify_url'] = $array['notify_url'];
		$this->array['out_trade_no'] = $array['order_sn'];
		$this->array['request_time'] = date('YmdHis');
		$this->array['amount'] = $array['amount'] ;
		$this->array['goods_price'] = $array['amount'];
		$getURL = $this->getUrl($this->array) ;
		header("Location: " .$getURL);
		exit;
   }


    protected function getUrl($array)
    {
        $weibopay = new Weibopay();
        $url =sinapay_mas_url;
        $param=$array;
        ksort($param);
        $sign=$weibopay->getSignMsg($param);
        $param['sign']=$sign;
        $sendurl=$weibopay->createcurl_data($param);
        $dat=$weibopay->curlPost($url,$sendurl);
        $data = json_decode(urldecode($dat),true);
        if(!empty($data['redirect_url']))
        {
            return  $data['redirect_url'];
        }elseif($data['error_url']){
           return  $data['error_url'];
        }else{
        	tojson('调取新浪支付接口失败！');
        }

    }

    //参数验证
     public  function chksign($data)
     {
        
         ksort($data);
         $weibopay = new Weibopay ();
       
         if ($weibopay->checkSignMsg($data, @$data["sign_type"],@$data["_input_charset"]))
         {
             // 如果回调成功，需要输出SUCCESS告知新浪回调服务器，已经收到异步通知。
             if($data['trade_status'] == 'PAY_FINISHED')
             {
                return true;
             }

         } else {
             
             return false;
         }


     }



}