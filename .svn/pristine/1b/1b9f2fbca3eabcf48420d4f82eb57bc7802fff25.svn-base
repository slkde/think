<?php
namespace pay\alipay;

class Alipay
{

 
  //老版本即时到账找不到demo了。从原来网站拿过来的源码 ，将就着看吧,参数有时间录入数据库
   
	  public $config  = [
	    'alipay_pay_method' => '2',
	    'partner' => '2088421584138932' , //合作身份者id，以2088开头的16位纯数字
	    'seller_email' => 'yxkj@yxecg.com', //收款支付宝账号，一般情况下收款账号就是签约账号
	    'key' => 'e27j2pydzv8yn2m42p9d8pdfc0ejk40v', //安全检验码，以数字和字母组成的32位字符
	    'sign_type' => 'MD5',  //签名方式 不需修改
	    'input_charset' =>'utf-8' ,
	    'cacert' =>'' ,
	    'transport' => 'http'
	  ];
   

      public $parameter = [
         'service' => 'create_direct_pay_by_user', //使用即时到帐交易接口
         'partner' => '2088421584138932', //合作身份者id，以2088开头的16位纯数字
         'seller_email' => 'yxkj@yxecg.com', //收款支付宝账号，一般情况下收款账号就是签约账号
         'payment_type' => 1,    //默认值为：1（商品购买）。
         'notify_url' => '',    //服务器异步通知页面路径 
         'return_url' => '',    //服务器同步通知页面路径 
         'out_trade_no' => '',  //商户订单号
         'subject' => '余额充值', //订单名称可以中文
         'total_fee' => '',           //付款金额
         '_input_charset' => 'utf-8', //字符编码格式 目前支持 gbk 或 utf-8
         'it_b_pay' => '5m'
      ];

    //发起支付，弹出支付页面
	public function pay($array)
	{

        $this->parameter['notify_url'] = $array['notify_url'];
        $this->parameter['return_url'] = $array['return_url'];
        $this->parameter['out_trade_no'] = $array['order_sn'];
        $this->parameter['total_fee'] = $array['amount'];

        $alipaySubmit = new Submit($this->config);
        $html_text = $alipaySubmit->buildRequestForm($this->parameter,"post", "确认");
        echo  $html_text; 
	} 
   
    //回调参数验证
    public function chksign($data)
    {
         $Boolean = $this->signcheck($data);
         if($Boolean)
         {
            // 支付宝解释: 交易成功且结束，即不可再做任何操作。
            if($data['trade_status'] == 'TRADE_FINISHED'){
              return true;
            //支付宝解释: 交易成功，且可对该交易做操作，如：多级分润、退款等。
            }elseif ($data['trade_status'] == 'TRADE_SUCCESS'){
              return true;
            }else{
              return false; 
            }
             
         }else{
             return false;
         }

    } 
  


      //验证 。 稍微做了一下改变
    function  signcheck($array)
    {
        //加载配置文件
        $config  =  $this->config;
        //计算得出通知验证结果
        $alipayNotify = new Notify($config); // 使用支付宝原生自带的累 和方法 这里只是引用了一下 而已
        //生成签名结果
        $isSign = $alipayNotify->getSignVeryfy($array, $array["sign"]);
        //获取支付宝远程服务器ATN结果（验证是否是支付宝发来的消息）
        $responseTxt = 'false';
        if (! empty($array["notify_id"])) {$responseTxt = $alipayNotify->getResponse($array["notify_id"]);}
        if (preg_match("/true$/i",$responseTxt) && $isSign) {
        return true;
        } else {
        return false;
        }

    }



       




}

  